# Chat Backend
[![Ask DeepWiki](https://devin.ai/assets/askdeepwiki.png)](https://deepwiki.com/MinHtetTharUTYCC/chat-backend)

This repository contains the backend service for a real-time chat application. It is built with NestJS and provides a feature-rich API for handling user authentication, real-time messaging, presence tracking, notifications, and more.

## Features

-   **Authentication**: Secure user registration and login using JWT (Access and Refresh Tokens). Refresh tokens are stored in `httpOnly` cookies for security.
-   **Real-Time Communication**: WebSocket-based messaging using Socket.IO for instant message delivery, typing indicators, and presence updates.
-   **Chat Management**: APIs for creating direct messages and group chats, adding/inviting members, updating chat titles, and searching chats.
-   **Message Handling**: Send, edit, and delete messages. Support for pinning/unpinning important messages within a chat.
-   **Presence System**: Real-time tracking of user online/offline status using Redis.
-   **Notifications**: In-app notifications for events like new messages, group invites, and message pins.
-   **Comprehensive Search**: Endpoints to search for users, groups, and messages within a specific chat.
-   **Database**: Uses Prisma as the ORM for seamless database interaction with PostgreSQL.
-   **API Documentation**: Auto-generated API documentation available via Swagger UI.

## Tech Stack

-   **Framework**: [NestJS](https://nestjs.com/)
-   **Language**: [TypeScript](https://www.typescriptlang.org/)
-   **Database ORM**: [Prisma](https://www.prisma.io/)
-   **Database**: [PostgreSQL](https://www.postgresql.org/)
-   **Real-time Layer**: [Socket.IO](https://socket.io/)
-   **Caching & Presence**: [Redis](https://redis.io/)
-   **Authentication**: [Passport.js](http://www.passportjs.org/) (JWT Strategy)
-   **Validation**: `class-validator`, `class-transformer`

## Getting Started

### Prerequisites

-   Node.js (v18 or higher)
-   npm or a compatible package manager
-   Docker and Docker Compose
-   A code editor like VS Code

### Environment Setup

1.  Clone the repository:
    ```sh
    git clone https://github.com/MinHtetTharUTYCC/chat-backend.git
    cd chat-backend
    ```

2.  Create a `.env` file in the root directory and populate it with the necessary environment variables. You can use the `docker-compose.yaml` file as a reference for database and Redis credentials.

    **`.env` example:**

    ```env
    # Application Port
    PORT=7000

    # Frontend URL for CORS
    FRONTEND_URL=http://localhost:9000

    # PostgreSQL Connection URL (for Prisma and the app)
    # The credentials should match those in docker-compose.yaml
    DATABASE_URL="postgresql://myuser:mypassword@localhost:5432/chatdb?schema=public"

    # Redis Connection URL
    # Password should match the one in docker-compose.yaml
    REDIS_URL="redis://:mypassword@localhost:6379"

    # JWT Secrets (use strong, unique secrets)
    JWT_ACCESS_SECRET="your-strong-access-secret"
    JWT_REFRESH_SECRET="your-strong-refresh-secret"
    ```

### Installation and Database

1.  Install project dependencies:
    ```sh
    npm install
    ```

2.  Start the PostgreSQL database and Redis services using Docker Compose:
    ```sh
    docker-compose up -d
    ```

3.  Apply database migrations using Prisma:
    ```sh
    npx prisma migrate dev
    ```

4.  Generate the Prisma Client:
    ```sh
    npx prisma generate
    ```

### Running the Application

-   **Development Mode (with hot-reloading):**
    ```sh
    npm run start:dev
    ```
    The application will be running on `http://localhost:7000`.

-   **Production Mode:**
    ```sh
    npm run build
    npm run start:prod
    ```

## API Documentation

Once the application is running, you can access the full API documentation, generated by Swagger, at:

`http://localhost:7000/api-docs`

This interactive UI provides detailed information on all available endpoints, request bodies, and response schemas.

## Key API Endpoints & Events

### Authentication (`/auth`)

-   `POST /register`: Creates a new user account.
-   `POST /login`: Authenticates a user and returns an access token. Sets a refresh token in an `httpOnly` cookie.
-   `POST /refresh`: Uses the refresh token cookie to issue a new access token.
-   `POST /logout`: Clears the user's refresh token from the database.

### WebSocket Events

The WebSocket gateway handles real-time communication. Clients should connect with their JWT access token in the `auth` payload.

-   **Client to Server:**
    -   `user_online`: Notifies the server that the user is online.
    -   `user_offline`: Notifies the server that the user is going offline.
    -   `heartbeat`: Sent periodically to maintain the "online" status.
    -   `join_chat`: Makes the client's socket join a specific chat room.
    -   `typing`: Emits a typing indicator to other users in a chat.

-   **Server to Client:**
    -   `new_message`: A new message has been sent in a chat.
    -   `message_edited`, `message_deleted`: A message has been modified or removed.
    -   `pin_added`, `pin_removed`: A message has been pinned or unpinned.
    -   `presence_update`: A user's online status has changed.
    -   `user_typing`: A user is currently typing in a chat.
    -   `new_chat`, `group_added`, `group_invited`: Notifications for new chats or group activities.

## Project Structure

The backend is organized into modules, each responsible for a specific domain:

-   `src/auth`: Handles user authentication, JWT strategies, and guards.
-   `src/users`: Manages user profiles and user search.
-   `src/chat`: Core module for chat management and the WebSocket gateway.
-   `src/message`: Handles creating, retrieving, and managing messages.
-   `src/notification`: Manages in-app notifications.
-   `src/presence`: User online/offline status management.
-   `src/search`: Provides search functionality across users, groups, and messages.
-   `src/database`: Contains the Prisma database service configuration.
-   `src/redis`: Contains the Redis service configuration.

## Deployment

This application includes configuration files for deployment on [Render](https://render.com/) and via Docker.

-   **Render**: The `render.yaml` file defines the service, build commands, and environment variables for one-click deployment on Render.
-   **Docker**: The `docker-compose.yaml` file is configured for a local development environment but can be adapted for production use to deploy the database and Redis instances. The application itself can be containerized using a `Dockerfile`.
